<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Predictor de Precios de Vivienda</title>

    <!-- Enlaza tu archivo de estilos externo en lugar del bloque <style> -->
    <link rel="stylesheet" href="styles.css">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
     <link rel="stylesheet" href="styles/styles.css">
</head>
<body>

    <!-- Contenedor donde inyectaremos header.html -->
  <div id="header-container"></div>

  <!-- Contenedor donde inyectaremos nav.html -->
  <div id="nav-container"></div>

<script>
    // Función genérica para cargar un fragmento HTML y “pegarlo” en un contenedor
    async function loadPartial(url, containerId) {
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`Error ${res.status} al cargar ${url}`);
        const html = await res.text();
        document.getElementById(containerId).innerHTML = html;
      } catch (err) {
        console.error(err);
      }
    }

    // Al cargar la página, llamamos a loadPartial para cada sección
    document.addEventListener('DOMContentLoaded', () => {
      loadPartial('partials/header.html', 'header-container');
      loadPartial('partials/nav.html',    'nav-container');
      loadPartial('partials/footer.html', 'footer-container');
    });
  </script>


    <div class="container">
        
        <h1>Predictor de Precios de Vivienda en Andalucía</h1>

        <div id="map"></div> <!-- Contenedor para el mapa -->

        <form id="predictionForm">
            <div>
                <label for="superficie">Superficie (m²):</label>
                <input type="number" id="superficie" name="superficie" value="120" required>
            </div>

            <div>
                <label for="habitaciones">Número de Habitaciones:</label>
                <input type="number" id="habitaciones" name="habitaciones" value="3" required>
            </div>

            <div>
                <label for="baños">Número de Baños:</label>
                <input type="number" id="baños" name="baños" value="2" required>
            </div>

            <div>
                <label for="latitud">Latitud:</label>
                <input type="number" id="latitud" name="latitud" value="37.196993481556994" step="any" required>
            </div>

            <div>
                <label for="longitud">Longitud:</label>
                <input type="number" id="longitud" name="longitud" value="-3.6164274080288976" step="any" required>
            </div>

            <div>
                <label for="tipo_propiedad">Tipo de Propiedad:</label>
                <select id="tipo_propiedad" name="tipo_propiedad" required>
                    <option value="piso" selected>Piso</option>
                    <option value="chalet">Chalet</option>
                    <option value="casa_rural">Casa Rural</option>
                    <option value="duplex">Dúplex</option>
                    <option value="atico">Ático</option>
                    <option value="estudio">Estudio</option>
                </select>
            </div>

            <button type="submit">Generar Predicción</button>
        </form>

        <div id="result">
            <!-- El resultado de la predicción aparecerá aquí -->
        </div>
    </div>

    <script>
        const form = document.getElementById('predictionForm');
        const resultDiv = document.getElementById('result');
        const latitudInput = document.getElementById('latitud');
        const longitudInput = document.getElementById('longitud');

        // 1) Definimos los límites aproximados de Andalucía
        const andaluciaBounds = [
            [36.00, -7.80],   // esquina sudoeste (lat, lng)
            [38.80, -0.10]    // esquina noreste  (lat, lng)
        ];

        // 2) Inicializamos el mapa “encerrado” solo en Andalucía
        const map = L.map('map', {
            maxBounds: andaluciaBounds,
            maxBoundsViscosity: 1.0, // no deja desplazar ni un píxel fuera de Andalucía
            minZoom: 7               // evita alejarse tanto que se vea fuera de Andalucía
        });

        // 3) Cargamos la capa base de OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // 4) Ajustamos la vista inicial para encuadrar toda Andalucía
        map.fitBounds(andaluciaBounds);

        let marker;

        // Función para actualizar los campos del formulario y el marcador
        function updateCoordinates(lat, lng) {
            latitudInput.value = lat.toFixed(10);
            longitudInput.value = lng.toFixed(10);

            if (marker) {
                map.removeLayer(marker);
            }
            marker = L.marker([lat, lng]).addTo(map);
            map.setView([lat, lng], map.getZoom());
        }

        // Si los inputs ya traían coordenadas al cargar la página, colocamos el marcador
        const initialLat = parseFloat(latitudInput.value);
        const initialLng = parseFloat(longitudInput.value);
        if (!isNaN(initialLat) && !isNaN(initialLng)) {
            updateCoordinates(initialLat, initialLng);
        }

        // Evento de clic en el mapa
        map.on('click', function(e) {
            updateCoordinates(e.latlng.lat, e.latlng.lng);
        });

        form.addEventListener('submit', async function(event) {
            event.preventDefault(); // Evitar el envío tradicional del formulario

            const formData = new FormData(form);
            const data = {};

            // Convertir FormData a un objeto JSON y asegurar tipos numéricos
            formData.forEach((value, key) => {
                if (['superficie', 'habitaciones', 'baños', 'latitud', 'longitud'].includes(key)) {
                    data[key] = parseFloat(value);
                } else {
                    data[key] = value;
                }
            });

            resultDiv.innerHTML = 'Calculando predicción...';

            try {
                const response = await fetch('http://127.0.0.1:5000/predict', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    if (result.prediction !== undefined) {
                        resultDiv.innerHTML = `
                            <h2>Precio Estimado:</h2>
                            <p>€ ${parseFloat(result.prediction).toLocaleString('es-ES', {
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            })}</p>
                        `;
                    } else {
                        resultDiv.innerHTML = `<p class="error">Respuesta inesperada del servidor.</p>`;
                    }
                } else {
                    resultDiv.innerHTML = `<p class="error">Error: ${result.error || response.statusText}</p>`;
                }

            } catch (error) {
                console.error('Error al realizar la petición:', error);
                resultDiv.innerHTML = `<p class="error">Error de conexión o al procesar la solicitud. Revisa la consola.</p>`;
            }
        });
    </script>
</body>
</html>
